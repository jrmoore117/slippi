"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t,r,n,o=require("lodash"),a=e(o),s=e(require("fs")),i=e(require("iconv-lite")),u=require("@shelacek/ubjson"),c=e(require("semver")),l=require("events"),p=e(require("moment")),m=require("stream"),f=e(require("net")),h=e(require("reconnect-core")),d=e(require("path"));function E(e,t,r,o,a){switch(e.source){case n.FILE:return s.readSync(e.fileDescriptor,t,r,o,a);case n.BUFFER:return e.buffer.copy(t,r,a,a+o);default:throw new Error("Source type not supported")}}function S(e){switch(e.source){case n.FILE:return s.fstatSync(e.fileDescriptor).size;case n.BUFFER:return e.buffer.length;default:throw new Error("Source type not supported")}}function y(e){var t=function(e){switch(e.source){case n.FILE:var t=s.openSync(e.filePath,"r");return{source:e.source,fileDescriptor:t};case n.BUFFER:return{source:e.source,buffer:e.buffer};default:throw new Error("Source type not supported")}}(e),r=function(e){var t=new Uint8Array(1);if(E(e,t,0,t.length,0),54===t[0])return 0;if(t[0]!=="{".charCodeAt(0))return 0;return 15}(t),o=function(e,t){var r=S(e);if(0===t)return r;var n=new Uint8Array(4);E(e,n,0,n.length,t-4);var o=n[0]<<24|n[1]<<16|n[2]<<8|n[3];if(o>0)return o;return r-t}(t,r),a=r+o+10;return{ref:t,rawDataPosition:r,rawDataLength:o,metadataPosition:a,metadataLength:function(e,t){return S(e)-t-1}(t,a),messageSizes:function(e,t){var r={};if(0===t)return r[54]=320,r[55]=6,r[56]=70,r[57]=1,r;var n=new Uint8Array(2);if(E(e,n,0,n.length,t),n[0]!==exports.Command.MESSAGE_SIZES)return{};var o=n[1];r[53]=o;var a=new Uint8Array(o-1);E(e,a,0,a.length,t+2);for(var s=0;s<o-1;s+=3){var i=a[s];r[i]=a[s+1]<<8|a[s+2]}return r}(t,r)}}function A(e){switch(e.ref.source){case n.FILE:s.closeSync(e.ref.fileDescriptor)}}function g(e,t){var r=new DataView(t.buffer);switch(e){case exports.Command.GAME_START:return{slpVersion:I(r,1)+"."+I(r,2)+"."+I(r,3),isTeams:x(r,13),isPAL:x(r,417),stageId:T(r,19),players:[0,1,2,3].map((function(e){var n=8*e,o=N(r,321+n),s="None";o!==N(r,325+n)?s="Mixed":1===o?s="UCF":2===o&&(s="Dween");var u,c,l=353+16*e,p=t.slice(l,l+16),m=(u=i.decode(p,"Shift_JIS").split("\0").shift(),c=a.map(u,(function(e){return(t=e.charCodeAt(0))>65280&&t<65375?t-65280+32:12288===t?32:t;var t})),String.fromCharCode.apply(String,c)),f=36*e;return{playerIndex:e,port:e+1,characterId:I(r,101+f),characterColor:I(r,104+f),startStocks:I(r,103+f),type:I(r,102+f),teamId:I(r,110+f),controllerFix:s,nametag:m}})),scene:I(r,419),gameMode:I(r,420)};case exports.Command.PRE_FRAME_UPDATE:return{frame:D(r,1),playerIndex:I(r,5),isFollower:x(r,6),seed:N(r,7),actionStateId:T(r,11),positionX:v(r,13),positionY:v(r,17),facingDirection:v(r,21),joystickX:v(r,25),joystickY:v(r,29),cStickX:v(r,33),cStickY:v(r,37),trigger:v(r,41),buttons:N(r,45),physicalButtons:T(r,49),physicalLTrigger:v(r,51),physicalRTrigger:v(r,55),percent:v(r,60)};case exports.Command.POST_FRAME_UPDATE:return{frame:D(r,1),playerIndex:I(r,5),isFollower:x(r,6),internalCharacterId:I(r,7),actionStateId:T(r,8),positionX:v(r,10),positionY:v(r,14),facingDirection:v(r,18),percent:v(r,22),shieldSize:v(r,26),lastAttackLanded:I(r,30),currentComboCount:I(r,31),lastHitBy:I(r,32),stocksRemaining:I(r,33),actionStateCounter:v(r,34),lCancelStatus:I(r,51)};case exports.Command.ITEM_UPDATE:return{frame:D(r,1),typeId:T(r,5),state:I(r,7),facingDirection:v(r,8),velocityX:v(r,12),velocityY:v(r,16),positionX:v(r,20),positionY:v(r,24),damageTaken:T(r,28),expirationTimer:T(r,30),spawnId:N(r,32)};case exports.Command.FRAME_BOOKEND:return{frame:D(r,1),latestFinalizedFrame:D(r,5)};case exports.Command.GAME_END:return{gameEndMethod:I(r,1),lrasInitiatorIndex:C(r,2)};default:return null}}function _(e,t,r){return t+r<=e.byteLength}function v(e,t){return _(e,t,4)?e.getFloat32(t):null}function D(e,t){return _(e,t,4)?e.getInt32(t):null}function C(e,t){return _(e,t,1)?e.getInt8(t):null}function N(e,t){return _(e,t,4)?e.getUint32(t):null}function T(e,t){return _(e,t,2)?e.getUint16(t):null}function I(e,t){return _(e,t,1)?e.getUint8(t):null}function x(e,t){return _(e,t,1)?!!e.getUint8(t):null}(t=exports.Command||(exports.Command={}))[t.MESSAGE_SIZES=53]="MESSAGE_SIZES",t[t.GAME_START=54]="GAME_START",t[t.PRE_FRAME_UPDATE=55]="PRE_FRAME_UPDATE",t[t.POST_FRAME_UPDATE=56]="POST_FRAME_UPDATE",t[t.GAME_END=57]="GAME_END",t[t.ITEM_UPDATE=59]="ITEM_UPDATE",t[t.FRAME_BOOKEND=60]="FRAME_BOOKEND",(r=exports.GameMode||(exports.GameMode={}))[r.VS=2]="VS",r[r.ONLINE=8]="ONLINE",function(e){e.BUFFER="buffer",e.FILE="file"}(n||(n={}));
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
var F=function(e,t){return(F=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function R(e,t){function r(){this.constructor=e}F(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var P,B=function(){return(B=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};(P=exports.State||(exports.State={}))[P.DAMAGE_START=75]="DAMAGE_START",P[P.DAMAGE_END=91]="DAMAGE_END",P[P.CAPTURE_START=223]="CAPTURE_START",P[P.CAPTURE_END=232]="CAPTURE_END",P[P.GUARD_START=178]="GUARD_START",P[P.GUARD_END=182]="GUARD_END",P[P.GROUNDED_CONTROL_START=14]="GROUNDED_CONTROL_START",P[P.GROUNDED_CONTROL_END=24]="GROUNDED_CONTROL_END",P[P.SQUAT_START=39]="SQUAT_START",P[P.SQUAT_END=41]="SQUAT_END",P[P.DOWN_START=183]="DOWN_START",P[P.DOWN_END=198]="DOWN_END",P[P.TECH_START=199]="TECH_START",P[P.TECH_END=204]="TECH_END",P[P.DYING_START=0]="DYING_START",P[P.DYING_END=10]="DYING_END",P[P.CONTROLLED_JUMP_START=24]="CONTROLLED_JUMP_START",P[P.CONTROLLED_JUMP_END=34]="CONTROLLED_JUMP_END",P[P.GROUND_ATTACK_START=44]="GROUND_ATTACK_START",P[P.GROUND_ATTACK_END=64]="GROUND_ATTACK_END",P[P.ROLL_FORWARD=233]="ROLL_FORWARD",P[P.ROLL_BACKWARD=234]="ROLL_BACKWARD",P[P.SPOT_DODGE=235]="SPOT_DODGE",P[P.AIR_DODGE=236]="AIR_DODGE",P[P.ACTION_WAIT=14]="ACTION_WAIT",P[P.ACTION_DASH=20]="ACTION_DASH",P[P.ACTION_KNEE_BEND=24]="ACTION_KNEE_BEND",P[P.GUARD_ON=178]="GUARD_ON",P[P.TECH_MISS_UP=183]="TECH_MISS_UP",P[P.TECH_MISS_DOWN=191]="TECH_MISS_DOWN",P[P.DASH=20]="DASH",P[P.TURN=18]="TURN",P[P.LANDING_FALL_SPECIAL=43]="LANDING_FALL_SPECIAL",P[P.JUMP_FORWARD=25]="JUMP_FORWARD",P[P.JUMP_BACKWARD=26]="JUMP_BACKWARD",P[P.FALL_FORWARD=30]="FALL_FORWARD",P[P.FALL_BACKWARD=31]="FALL_BACKWARD",P[P.GRAB=212]="GRAB",P[P.CLIFF_CATCH=252]="CLIFF_CATCH";var w={PUNISH_RESET_FRAMES:45,RECOVERY_RESET_FRAMES:45,COMBO_STRING_RESET_FRAMES:45},O={FIRST:-123,FIRST_PLAYABLE:-39};function L(e){return e&&2===e.players.length?[{playerIndex:e.players[0].playerIndex,opponentIndex:e.players[1].playerIndex},{playerIndex:e.players[1].playerIndex,opponentIndex:e.players[0].playerIndex}]:[]}function U(e,t){return!(!e||!t)&&t.stocksRemaining-e.stocksRemaining>0}function G(e){var t=e>=exports.State.GROUNDED_CONTROL_START&&e<=exports.State.GROUNDED_CONTROL_END,r=e>=exports.State.SQUAT_START&&e<=exports.State.SQUAT_END,n=e>exports.State.GROUND_ATTACK_START&&e<=exports.State.GROUND_ATTACK_END,o=e===exports.State.GRAB;return t||r||n||o}function M(e){return e>=exports.State.TECH_START&&e<=exports.State.TECH_END}function k(e){return e>=exports.State.DOWN_START&&e<=exports.State.DOWN_END}function b(e){return e>=exports.State.DAMAGE_START&&e<=exports.State.DAMAGE_END}function W(e){return e>=exports.State.CAPTURE_START&&e<=exports.State.CAPTURE_END}function H(e){return e>=exports.State.DYING_START&&e<=exports.State.DYING_END}function Y(e,t){return a.get(e,"percent",0)-a.get(t,"percent",0)}var K=[exports.State.DASH,exports.State.TURN,exports.State.DASH],z=function(){function e(){this.playerPermutations=new Array,this.state=new Map}return e.prototype.setPlayerPermutations=function(e){var t=this;this.playerPermutations=e,this.playerPermutations.forEach((function(e){var r={playerCounts:{playerIndex:e.playerIndex,opponentIndex:e.opponentIndex,wavedashCount:0,wavelandCount:0,airDodgeCount:0,dashDanceCount:0,spotDodgeCount:0,ledgegrabCount:0,rollCount:0},animations:[]};t.state.set(e,r)}))},e.prototype.processFrame=function(e){var t=this;this.playerPermutations.forEach((function(r){!function(e,t,r){var n=r.players[t.playerIndex].post,o=function(t,r){r&&(e.playerCounts[t]+=1)};e.animations.push(n.actionStateId);var s=e.animations.slice(-3),i=n.actionStateId,u=s[s.length-2],c=a.isEqual(s,K);o("dashDanceCount",c);var l=function(e,t){var r=j(e),n=j(t);return r&&!n}(i,u);o("rollCount",l);var p=function(e,t){var r=J(e),n=J(t);return r&&!n}(i,u);o("spotDodgeCount",p);var m=function(e,t){var r=V(e),n=V(t);return r&&!n}(i,u);o("airDodgeCount",m);var f=function(e,t){var r=q(e),n=q(t);return r&&!n}(i,u);o("ledgegrabCount",f),function(e,t){var r=a.last(t),n=t[t.length-2],o=r===exports.State.LANDING_FALL_SPECIAL,s=function(e){if(e===exports.State.AIR_DODGE)return!0;var t=e>=exports.State.CONTROLLED_JUMP_START,r=e<=exports.State.CONTROLLED_JUMP_END;return t&&r}(n);if(!o||!s)return;var i=t.slice(-8),u=a.keyBy(i,(function(e){return e}));if(2===a.size(u)&&u[exports.State.AIR_DODGE])return;u[exports.State.AIR_DODGE]&&(e.airDodgeCount-=1);u[exports.State.ACTION_KNEE_BEND]?e.wavedashCount+=1:e.wavelandCount+=1}(e.playerCounts,e.animations)}(t.state.get(r),r,e)}))},e.prototype.fetch=function(){var e=this;return Array.from(this.state.keys()).map((function(t){return e.state.get(t).playerCounts}))},e}();function j(e){return e===exports.State.ROLL_BACKWARD||e===exports.State.ROLL_FORWARD}function J(e){return e===exports.State.SPOT_DODGE}function V(e){return e===exports.State.AIR_DODGE}function q(e){return e===exports.State.CLIFF_CATCH}var Z=function(){function e(){this.playerPermutations=new Array,this.conversions=new Array,this.state=new Map,this.metadata={lastEndFrameByOppIdx:{}}}return e.prototype.setPlayerPermutations=function(e){var t=this;this.playerPermutations=e,this.playerPermutations.forEach((function(e){t.state.set(e,{conversion:null,move:null,resetCounter:0,lastHitAnimation:null})}))},e.prototype.processFrame=function(e,t){var r=this;this.playerPermutations.forEach((function(n){var o=r.state.get(n);!function(e,t,r,n,o){var s=n.players[r.playerIndex].post,i=a.get(e,[s.frame-1,"players",r.playerIndex,"post"],{}),u=n.players[r.opponentIndex].post,c=a.get(e,[s.frame-1,"players",r.opponentIndex,"post"],{}),l=b(u.actionStateId),p=W(u.actionStateId),m=Y(u,c),f=s.actionStateId!==t.lastHitAnimation,h=s.actionStateCounter,d=i.actionStateCounter,E=h<d;(f||E)&&(t.lastHitAnimation=null);(l||p)&&(t.conversion||(t.conversion={playerIndex:r.playerIndex,opponentIndex:r.opponentIndex,startFrame:s.frame,endFrame:null,startPercent:c.percent||0,currentPercent:u.percent||0,endPercent:null,moves:[],didKill:!1,openingType:"unknown"},o.push(t.conversion)),m&&(t.lastHitAnimation||(t.move={frame:s.frame,moveId:s.lastAttackLanded,hitCount:0,damage:0},t.conversion.moves.push(t.move)),t.move&&(t.move.hitCount+=1,t.move.damage+=m),t.lastHitAnimation=i.actionStateId));if(!t.conversion)return;var S=G(u.actionStateId),y=U(u,c);y||(t.conversion.currentPercent=u.percent||0);(l||p)&&(t.resetCounter=0);var A=0===t.resetCounter&&S,g=t.resetCounter>0;(A||g)&&(t.resetCounter+=1);var _=!1;y&&(t.conversion.didKill=!0,_=!0);t.resetCounter>w.PUNISH_RESET_FRAMES&&(_=!0);_&&(t.conversion.endFrame=s.frame,t.conversion.endPercent=c.percent||0,t.conversion=null,t.move=null)}(t,o,n,e,r.conversions)}))},e.prototype.fetch=function(){return this._populateConversionTypes(),this.conversions},e.prototype._populateConversionTypes=function(){var e=this,t=a.filter(this.conversions,(function(e){return"unknown"===e.openingType}));a.chain(t).groupBy("startFrame").orderBy((function(e){return a.get(e,[0,"startFrame"])})).value().forEach((function(t){var r=t.length>=2;t.forEach((function(t){if(e.metadata.lastEndFrameByOppIdx[t.playerIndex]=t.endFrame,r)t.openingType="trade";else{var n=e.metadata.lastEndFrameByOppIdx[t.opponentIndex],o=n&&n>t.startFrame;t.openingType=o?"counter-attack":"neutral-win"}}))}))},e}();var X=function(){function e(){this.playerPermutations=new Array,this.state=new Map,this.combos=new Array}return e.prototype.setPlayerPermutations=function(e){var t=this;this.playerPermutations=e,this.playerPermutations.forEach((function(e){t.state.set(e,{combo:null,move:null,resetCounter:0,lastHitAnimation:null})}))},e.prototype.processFrame=function(e,t){var r=this;this.playerPermutations.forEach((function(n){var o=r.state.get(n);!function(e,t,r,n,o){var s=n.players[r.playerIndex].post,i=a.get(e,[s.frame-1,"players",r.playerIndex,"post"],{}),u=n.players[r.opponentIndex].post,c=a.get(e,[s.frame-1,"players",r.opponentIndex,"post"],{}),l=b(u.actionStateId),p=W(u.actionStateId),m=Y(u,c),f=s.actionStateId!==t.lastHitAnimation,h=s.actionStateCounter,d=i.actionStateCounter,E=h<d;(f||E)&&(t.lastHitAnimation=null);(l||p)&&(t.combo||(t.combo={playerIndex:r.playerIndex,opponentIndex:r.opponentIndex,startFrame:s.frame,endFrame:null,startPercent:c.percent||0,currentPercent:u.percent||0,endPercent:null,moves:[],didKill:!1},o.push(t.combo)),m&&(t.lastHitAnimation||(t.move={frame:s.frame,moveId:s.lastAttackLanded,hitCount:0,damage:0},t.combo.moves.push(t.move)),t.move&&(t.move.hitCount+=1,t.move.damage+=m),t.lastHitAnimation=i.actionStateId));if(!t.combo)return;var S=M(u.actionStateId),y=k(u.actionStateId),A=U(u,c),g=H(u.actionStateId);A||(t.combo.currentPercent=u.percent||0);l||p||S||y||g?t.resetCounter=0:t.resetCounter+=1;var _=!1;A&&(t.combo.didKill=!0,_=!0);t.resetCounter>w.COMBO_STRING_RESET_FRAMES&&(_=!0);_&&(t.combo.endFrame=s.frame,t.combo.endPercent=c.percent||0,t.combo=null,t.move=null)}(t,o,n,e,r.combos)}))},e.prototype.fetch=function(){return this.combos},e}();var Q,$=function(){function e(){this.state=new Map,this.playerPermutations=new Array,this.stocks=new Array}return e.prototype.setPlayerPermutations=function(e){var t=this;this.playerPermutations=e,this.playerPermutations.forEach((function(e){t.state.set(e,{stock:null})}))},e.prototype.processFrame=function(e,t){var r=this;this.playerPermutations.forEach((function(n){var o=r.state.get(n);!function(e,t,r,n,o){var s=n.players[r.playerIndex].post,i=a.get(e,[s.frame-1,"players",r.playerIndex,"post"],{});if(t.stock)U(s,i)?(t.stock.endFrame=s.frame,t.stock.endPercent=i.percent||0,t.stock.deathAnimation=s.actionStateId,t.stock=null):t.stock.currentPercent=s.percent||0;else{if(H(s.actionStateId))return;t.stock={playerIndex:r.playerIndex,opponentIndex:r.opponentIndex,startFrame:s.frame,endFrame:null,startPercent:0,endPercent:null,currentPercent:0,count:s.stocksRemaining,deathAnimation:null},o.push(t.stock)}}(t,o,n,e,r.stocks)}))},e.prototype.fetch=function(){return this.stocks},e}();!function(e){e[e.DZ=0]="DZ",e[e.NE=1]="NE",e[e.SE=2]="SE",e[e.SW=3]="SW",e[e.NW=4]="NW",e[e.N=5]="N",e[e.E=6]="E",e[e.S=7]="S",e[e.W=8]="W"}(Q||(Q={}));var ee=function(){function e(){this.playerPermutations=new Array,this.state=new Map}return e.prototype.setPlayerPermutations=function(e){var t=this;this.playerPermutations=e,this.playerPermutations.forEach((function(e){var r={playerIndex:e.playerIndex,opponentIndex:e.opponentIndex,inputCount:0};t.state.set(e,r)}))},e.prototype.processFrame=function(e,t){var r=this;this.playerPermutations.forEach((function(n){var o=r.state.get(n);!function(e,t,r,n){var o=n.players[r.playerIndex].pre,s=a.get(e,[o.frame-1,"players",r.playerIndex,"pre"],{});if(o.frame<O.FIRST_PLAYABLE)return;var i=~s.physicalButtons,u=o.physicalButtons,c=i&u&4095;t.inputCount+=function(e){var t,r=e;for(t=0;r;t+=1)r&=r-1;return t}(c);var l=te(s.joystickX,s.joystickY),p=te(o.joystickX,o.joystickY);l!==p&&0!==p&&(t.inputCount+=1);var m=te(s.cStickX,s.cStickY),f=te(o.cStickX,o.cStickY);m!==f&&0!==f&&(t.inputCount+=1);s.lTrigger<.3&&o.lTrigger>=.3&&(t.inputCount+=1);s.rTrigger<.3&&o.rTrigger>=.3&&(t.inputCount+=1)}(t,o,n,e)}))},e.prototype.fetch=function(){var e=this;return Array.from(this.state.keys()).map((function(t){return e.state.get(t)}))},e}();function te(e,t){var r=Q.DZ;return e>=.2875&&t>=.2875?r=Q.NE:e>=.2875&&t<=-.2875?r=Q.SE:e<=-.2875&&t<=-.2875?r=Q.SW:e<=-.2875&&t>=.2875?r=Q.NW:t>=.2875?r=Q.N:e>=.2875?r=Q.E:t<=-.2875?r=Q.S:e<=-.2875&&(r=Q.W),r}var re={processOnTheFly:!1},ne=function(){function e(e){this.lastProcessedFrame=null,this.frames={},this.playerPermutations=new Array,this.allComputers=new Array,this.options=Object.assign({},re,e)}return e.prototype.setPlayerPermutations=function(e){this.playerPermutations=e,this.allComputers.forEach((function(t){return t.setPlayerPermutations(e)}))},e.prototype.register=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];(e=this.allComputers).push.apply(e,t)},e.prototype.process=function(){var e=this;if(0!==this.playerPermutations.length)for(var t=this.lastProcessedFrame?this.lastProcessedFrame+1:O.FIRST,r=function(){var r=n.frames[t];if(!function(e,t){var r=a.first(e),n=a.get(t,["players",r.playerIndex,"post"]),o=a.get(t,["players",r.opponentIndex,"post"]);return Boolean(n&&o)}(n.playerPermutations,r))return{value:void 0};n.allComputers.forEach((function(t){return t.processFrame(r,e.frames)})),n.lastProcessedFrame=t,t++},n=this;this.frames[t];){var o=r();if("object"==typeof o)return o.value}},e.prototype.addFrame=function(e){this.frames[e.frame]=e,this.options.processOnTheFly&&this.process()},e}();function oe(e,t,r,n,o){var s=a.keyBy(t,"playerIndex"),i=a.groupBy(r,"playerIndex"),u=a.groupBy(n,"playerIndex"),c=a.mapValues(u,(function(e){return a.groupBy(e,"openingType")})),l=o/3600;return e.map((function(e){var t=e.playerIndex,r=e.opponentIndex,n=a.get(s,[t,"inputCount"])||0,o=a.get(u,t)||[],p=o.filter((function(e){return e.moves.length>1})),m=a.get(i,r)||[],f=a.filter(m,"endFrame"),h=o.length,d=p.length,E=a.sumBy(m,"currentPercent")||0,S=f.length;return{playerIndex:t,opponentIndex:r,inputCount:n,conversionCount:h,totalDamage:E,killCount:S,successfulConversions:ae(d,h),inputsPerMinute:ae(n,l),openingsPerKill:ae(h,S),damagePerOpening:ae(E,h),neutralWinRatio:se(c,t,r,"neutral-win"),counterHitRatio:se(c,t,r,"counter-attack"),beneficialTradeRatio:ie(c,t,r)}}))}function ae(e,t){return{count:e,total:t,ratio:t?e/t:null}}function se(e,t,r,n){var o=a.get(e,[t,n])||[],s=a.get(e,[r,n])||[];return ae(o.length,o.length+s.length)}function ie(e,t,r){var n=a.get(e,[t,"trade"])||[],o=a.get(e,[r,"trade"])||[],s=[];return a.zip(n,o).forEach((function(e){var t=a.first(e),r=a.last(e),n=t.currentPercent-t.startPercent,o=r.currentPercent-r.startPercent;(t.didKill&&!r.didKill||n>o)&&s.push(t)})),ae(s.length,n.length)}var ue;(ue=exports.SlpParserEvent||(exports.SlpParserEvent={})).SETTINGS="settings",ue.END="end",ue.FRAME="frame",ue.FINALIZED_FRAME="finalized-frame";var ce=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.frames={},t.settings=null,t.gameEnd=null,t.latestFrameIndex=null,t.settingsComplete=!1,t.lastFinalizedFrame=O.FIRST-1,t}return R(t,e),t.prototype.handleCommand=function(e,t){switch(e){case exports.Command.GAME_START:this._handleGameStart(t);break;case exports.Command.POST_FRAME_UPDATE:this._handlePostFrameUpdate(t),this._handleFrameUpdate(e,t);break;case exports.Command.PRE_FRAME_UPDATE:this._handleFrameUpdate(e,t);break;case exports.Command.ITEM_UPDATE:this._handleItemUpdate(t);break;case exports.Command.FRAME_BOOKEND:this._handleFrameBookend(t);break;case exports.Command.GAME_END:this._handleGameEnd(t)}},t.prototype.reset=function(){this.frames={},this.settings=null,this.gameEnd=null,this.latestFrameIndex=null,this.settingsComplete=!1,this.lastFinalizedFrame=O.FIRST-1},t.prototype.getLatestFrameNumber=function(){return this.latestFrameIndex},t.prototype.getPlayableFrameCount=function(){return this.latestFrameIndex<O.FIRST_PLAYABLE?0:this.latestFrameIndex-O.FIRST_PLAYABLE},t.prototype.getLatestFrame=function(){var e=this.getFrames(),t=this.latestFrameIndex||O.FIRST,r=this.gameEnd?t:t-1;return a.get(e,r)||null},t.prototype.getSettings=function(){return this.settingsComplete?this.settings:null},t.prototype.getGameEnd=function(){return this.gameEnd},t.prototype.getFrames=function(){return this.frames},t.prototype.getFrame=function(e){return this.frames[e]||null},t.prototype._handleGameEnd=function(e){this.latestFrameIndex!==this.lastFinalizedFrame&&this._finalizeFrames(this.latestFrameIndex),e=e,this.gameEnd=e,this.emit(exports.SlpParserEvent.END,this.gameEnd)},t.prototype._handleGameStart=function(e){this.settings=e;var t=e.players;this.settings.players=t.filter((function(e){return 3!==e.type})),c.gte(e.slpVersion,"1.6.0")&&this._completeSettings()},t.prototype._handlePostFrameUpdate=function(e){if(!this.settingsComplete){if(e.frame<=O.FIRST){var t=e.playerIndex,r=a.keyBy(this.settings.players,"playerIndex");switch(e.internalCharacterId){case 7:r[t].characterId=19;break;case 19:r[t].characterId=18}}e.frame>O.FIRST&&this._completeSettings()}},t.prototype._handleFrameUpdate=function(e,t){t=t;var r=e===exports.Command.PRE_FRAME_UPDATE?"pre":"post",n=t.isFollower?"followers":"players";this.latestFrameIndex=t.frame,a.set(this.frames,[t.frame,n,t.playerIndex,r],t),a.set(this.frames,[t.frame,"frame"],t.frame);var o=this.getSettings();!o||c.lte(o.slpVersion,"2.2.0")?(this.emit(exports.SlpParserEvent.FRAME,this.frames[t.frame]),this._finalizeFrames(t.frame-1)):a.set(this.frames,[t.frame,"isTransferComplete"],!1)},t.prototype._handleItemUpdate=function(e){var t=a.get(this.frames,[e.frame,"items"],[]);t.push(e),a.set(this.frames,[e.frame,"items"],t)},t.prototype._handleFrameBookend=function(e){var t=e.frame,r=e.latestFinalizedFrame;if(a.set(this.frames,[t,"isTransferComplete"],!0),this.emit(exports.SlpParserEvent.FRAME,this.frames[t]),this.settings.gameMode===exports.GameMode.ONLINE&&r>=O.FIRST){if(r<t-7)throw new Error("latestFinalizedFrame should be within 7 frames of "+t);this._finalizeFrames(r)}else this._finalizeFrames(e.frame-7)},t.prototype._finalizeFrames=function(e){for(;this.lastFinalizedFrame<e;){for(var t=this.lastFinalizedFrame+1,r=this.getFrame(t),n=0,o=this.settings.players;n<o.length;n++){var a=o[n],s=r.players[a.playerIndex],i=s.pre,u=s.post;if(!i||!u)throw new Error("Could not finalize frame "+t+" of "+e+": missing "+(i?"pre":"post")+"-frame update for player "+a.playerIndex)}this.emit(exports.SlpParserEvent.FINALIZED_FRAME,r),this.lastFinalizedFrame=t}},t.prototype._completeSettings=function(){this.settingsComplete||(this.settingsComplete=!0,this.emit(exports.SlpParserEvent.SETTINGS,this.settings))},t}(l.EventEmitter),le=function(){function e(e,t){var r=this;if(this.readPosition=null,this.actionsComputer=new z,this.conversionComputer=new Z,this.comboComputer=new X,this.stockComputer=new $,this.inputComputer=new ee,a.isString(e))this.input={source:n.FILE,filePath:e};else{if(!(e instanceof Buffer))throw new Error("Cannot create SlippiGame with input of that type");this.input={source:n.BUFFER,buffer:e}}this.statsComputer=new ne(t),this.statsComputer.register(this.actionsComputer,this.comboComputer,this.conversionComputer,this.inputComputer,this.stockComputer),this.parser=new ce,this.parser.on(exports.SlpParserEvent.SETTINGS,(function(e){var t=L(e);r.statsComputer.setPlayerPermutations(t)})),this.parser.on(exports.SlpParserEvent.FINALIZED_FRAME,(function(e){r.statsComputer.addFrame(e)}))}return e.prototype._process=function(e){var t=this;if(void 0===e&&(e=!1),null===this.parser.getGameEnd()){var r=y(this.input);this.readPosition=function(e,t,r){void 0===r&&(r=null);for(var n=e.ref,o=r||e.rawDataPosition,s=e.rawDataPosition+e.rawDataLength,i=a.mapValues(e.messageSizes,(function(e){return new Uint8Array(e+1)})),u=new Uint8Array(1);o<s;){E(n,u,0,1,o);var c=u[0],l=i[c];if(void 0===l)return o;if(l.length>s-o)return o;if(E(n,l,0,l.length,o),t(c,g(c,l)))break;o+=l.length}return o}(r,(function(r,n){return!!n&&(t.parser.handleCommand(r,n),e&&null!==t.parser.getSettings())}),this.readPosition),A(r)}},e.prototype.getSettings=function(){return this._process(!0),this.parser.getSettings()},e.prototype.getLatestFrame=function(){return this._process(),this.parser.getLatestFrame()},e.prototype.getGameEnd=function(){return this._process(),this.parser.getGameEnd()},e.prototype.getFrames=function(){return this._process(),this.parser.getFrames()},e.prototype.getStats=function(){if(this.finalStats)return this.finalStats;this._process(),this.statsComputer.process();var e=this.inputComputer.fetch(),t=this.stockComputer.fetch(),r=this.conversionComputer.fetch(),n=L(this.parser.getSettings()),o=this.parser.getPlayableFrameCount(),a=oe(n,e,t,r,o),s={lastFrame:this.parser.getLatestFrameNumber(),playableFrameCount:o,stocks:t,conversions:r,combos:this.comboComputer.fetch(),actionCounts:this.actionsComputer.fetch(),overall:a,gameComplete:null!==this.parser.getGameEnd()};return null!==this.parser.getGameEnd()&&(this.finalStats=s),s},e.prototype.getMetadata=function(){if(this.metadata)return this.metadata;var e=y(this.input);return this.metadata=function(e){if(e.metadataLength<=0)return null;var t=new Uint8Array(e.metadataLength);E(e.ref,t,0,t.length,e.metadataPosition);var r=null;try{r=u.decode(t)}catch(e){}return r}(e),A(e),this.metadata},e.prototype.getFilePath=function(){return this.input.source!==n.FILE?null:this.input.filePath||null},e}();var pe=Object.freeze({__proto__:null,getDeathDirection:function(e){if(e>10)return null;switch(e){case 0:return"down";case 1:return"left";case 2:return"right";default:return"up"}}}),me=[{id:0,name:"Captain Falcon",shortName:"Falcon",colors:["Default","Black","Red","White","Green","Blue"]},{id:1,name:"Donkey Kong",shortName:"DK",colors:["Default","Black","Red","Blue","Green"]},{id:2,name:"Fox",shortName:"Fox",colors:["Default","Red","Blue","Green"]},{id:3,name:"Mr. Game & Watch",shortName:"G&W",colors:["Default","Red","Blue","Green"]},{id:4,name:"Kirby",shortName:"Kirby",colors:["Default","Yellow","Blue","Red","Green","White"]},{id:5,name:"Bowser",shortName:"Bowser",colors:["Default","Red","Blue","Black"]},{id:6,name:"Link",shortName:"Link",colors:["Default","Red","Blue","Black","White"]},{id:7,name:"Luigi",shortName:"Luigi",colors:["Default","White","Blue","Red"]},{id:8,name:"Mario",shortName:"Mario",colors:["Default","Yellow","Black","Blue","Green"]},{id:9,name:"Marth",shortName:"Marth",colors:["Default","Red","Green","Black","White"]},{id:10,name:"Mewtwo",shortName:"Mewtwo",colors:["Default","Red","Blue","Green"]},{id:11,name:"Ness",shortName:"Ness",colors:["Default","Yellow","Blue","Green"]},{id:12,name:"Peach",shortName:"Peach",colors:["Default","Daisy","White","Blue","Green"]},{id:13,name:"Pikachu",shortName:"Pikachu",colors:["Default","Red","Party Hat","Cowboy Hat"]},{id:14,name:"Ice Climbers",shortName:"ICs",colors:["Default","Green","Orange","Red"]},{id:15,name:"Jigglypuff",shortName:"Puff",colors:["Default","Red","Blue","Headband","Crown"]},{id:16,name:"Samus",shortName:"Samus",colors:["Default","Pink","Black","Green","Purple"]},{id:17,name:"Yoshi",shortName:"Yoshi",colors:["Default","Red","Blue","Yellow","Pink","Cyan"]},{id:18,name:"Zelda",shortName:"Zelda",colors:["Default","Red","Blue","Green","White"]},{id:19,name:"Sheik",shortName:"Sheik",colors:["Default","Red","Blue","Green","White"]},{id:20,name:"Falco",shortName:"Falco",colors:["Default","Red","Blue","Green"]},{id:21,name:"Young Link",shortName:"YLink",colors:["Default","Red","Blue","White","Black"]},{id:22,name:"Dr. Mario",shortName:"Doc",colors:["Default","Red","Blue","Green","Black"]},{id:23,name:"Roy",shortName:"Roy",colors:["Default","Red","Blue","Green","Yellow"]},{id:24,name:"Pichu",shortName:"Pichu",colors:["Default","Red","Blue","Green"]},{id:25,name:"Ganondorf",shortName:"Ganon",colors:["Default","Red","Blue","Green","Purple"]}];function fe(e){if(e<0||e>=me.length)throw new Error("Invalid character id: "+e);return me[e]}var he=Object.freeze({__proto__:null,getAllCharacters:function(){return me},getCharacterInfo:fe,getCharacterShortName:function(e){return fe(e).shortName},getCharacterName:function(e){return fe(e).name},getCharacterColorName:function(e,t){return fe(e).colors[t]}}),de={id:-1,name:"Unknown Move",shortName:"unknown"},Ee={1:{id:1,name:"Miscellaneous",shortName:"misc"},2:{id:2,name:"Jab",shortName:"jab"},3:{id:3,name:"Jab",shortName:"jab"},4:{id:4,name:"Jab",shortName:"jab"},5:{id:5,name:"Rapid Jabs",shortName:"rapid-jabs"},6:{id:6,name:"Dash Attack",shortName:"dash"},7:{id:7,name:"Forward Tilt",shortName:"ftilt"},8:{id:8,name:"Up Tilt",shortName:"utilt"},9:{id:9,name:"Down Tilt",shortName:"dtilt"},10:{id:10,name:"Forward Smash",shortName:"fsmash"},11:{id:11,name:"Up Smash",shortName:"usmash"},12:{id:12,name:"Down Smash",shortName:"dsmash"},13:{id:13,name:"Neutral Air",shortName:"nair"},14:{id:14,name:"Forward Air",shortName:"fair"},15:{id:15,name:"Back Air",shortName:"bair"},16:{id:16,name:"Up Air",shortName:"uair"},17:{id:17,name:"Down Air",shortName:"dair"},18:{id:18,name:"Neutral B",shortName:"neutral-b"},19:{id:19,name:"Side B",shortName:"side-b"},20:{id:20,name:"Up B",shortName:"up-b"},21:{id:21,name:"Down B",shortName:"down-b"},50:{id:50,name:"Getup Attack",shortName:"getup"},51:{id:51,name:"Getup Attack (Slow)",shortName:"getup-slow"},52:{id:52,name:"Grab Pummel",shortName:"pummel"},53:{id:53,name:"Forward Throw",shortName:"fthrow"},54:{id:54,name:"Back Throw",shortName:"bthrow"},55:{id:55,name:"Up Throw",shortName:"uthrow"},56:{id:56,name:"Down Throw",shortName:"dthrow"},61:{id:61,name:"Edge Attack (Slow)",shortName:"edge-slow"},62:{id:62,name:"Edge Attack",shortName:"edge"}};function Se(e){var t=Ee[e];return t||de}var ye=Object.freeze({__proto__:null,UnknownMove:de,getMoveInfo:Se,getMoveShortName:function(e){return Se(e).shortName},getMoveName:function(e){return Se(e).name}}),Ae={2:{id:2,name:"Fountain of Dreams"},3:{id:3,name:"Pokémon Stadium"},4:{id:4,name:"Princess Peach's Castle"},5:{id:5,name:"Kongo Jungle"},6:{id:6,name:"Brinstar"},7:{id:7,name:"Corneria"},8:{id:8,name:"Yoshi's Story"},9:{id:9,name:"Onett"},10:{id:10,name:"Mute City"},11:{id:11,name:"Rainbow Cruise"},12:{id:12,name:"Jungle Japes"},13:{id:13,name:"Great Bay"},14:{id:14,name:"Hyrule Temple"},15:{id:15,name:"Brinstar Depths"},16:{id:16,name:"Yoshi's Island"},17:{id:17,name:"Green Greens"},18:{id:18,name:"Fourside"},19:{id:19,name:"Mushroom Kingdom I"},20:{id:20,name:"Mushroom Kingdom II"},22:{id:22,name:"Venom"},23:{id:23,name:"Poké Floats"},24:{id:24,name:"Big Blue"},25:{id:25,name:"Icicle Mountain"},26:{id:26,name:"Icetop"},27:{id:27,name:"Flat Zone"},28:{id:28,name:"Dream Land N64"},29:{id:29,name:"Yoshi's Island N64"},30:{id:30,name:"Kongo Jungle N64"},31:{id:31,name:"Battlefield"},32:{id:32,name:"Final Destination"}};function ge(e){var t=Ae[e];if(!t)throw new Error("Invalid stage with id "+e);return t}var _e,ve=Object.freeze({__proto__:null,STAGE_FOD:2,STAGE_POKEMON:3,STAGE_YOSHIS:8,STAGE_DREAM_LAND:28,STAGE_BATTLEFIELD:31,STAGE_FD:32,getStageInfo:ge,getStageName:function(e){return ge(e).name}});!function(e){e[e.HANDSHAKE=1]="HANDSHAKE",e[e.REPLAY=2]="REPLAY",e[e.KEEP_ALIVE=3]="KEEP_ALIVE"}(_e||(_e={}));var De,Ce,Ne,Te,Ie=function(){function e(){this.receiveBuf=Buffer.from([]),this.messages=new Array}return e.prototype.receive=function(e){for(this.receiveBuf=Buffer.concat([this.receiveBuf,e]);this.receiveBuf.length>=4;){var t=this.receiveBuf.readUInt32BE(0);if(this.receiveBuf.length<t+4)return;var r=this.receiveBuf.slice(4,t+4);this.messages.push(u.decode(r)),this.receiveBuf=this.receiveBuf.slice(t+4)}},e.prototype.getReceiveBuffer=function(){return this.receiveBuf},e.prototype.getMessages=function(){var e=this.messages;return this.messages=[],e},e.prototype.genHandshakeOut=function(e,t,r){void 0===r&&(r=!1);var n=Buffer.from([0,0,0,0]);n.writeUInt32BE(t,0);var o={type:_e.HANDSHAKE,payload:{cursor:e,clientToken:Uint8Array.from(n),isRealtime:r}},a=u.encode(o,{optimizeArrays:!0}),s=Buffer.concat([Buffer.from([0,0,0,0]),Buffer.from(a)]);return s.writeUInt32BE(a.byteLength,0),s},e}();(De=exports.ConnectionEvent||(exports.ConnectionEvent={})).HANDSHAKE="handshake",De.STATUS_CHANGE="statusChange",De.DATA="data",De.INFO="loginfo",De.WARN="logwarn",(Ce=exports.ConnectionStatus||(exports.ConnectionStatus={}))[Ce.DISCONNECTED=0]="DISCONNECTED",Ce[Ce.CONNECTING=1]="CONNECTING",Ce[Ce.CONNECTED=2]="CONNECTED",Ce[Ce.RECONNECT_WAIT=3]="RECONNECT_WAIT",(Ne=exports.Ports||(exports.Ports={}))[Ne.DEFAULT=51441]="DEFAULT",Ne[Ne.LEGACY=666]="LEGACY",Ne[Ne.RELAY_START=53741]="RELAY_START",function(e){e.INITIAL="initial",e.LEGACY="legacy",e.NORMAL="normal"}(Te||(Te={}));var xe,Fe={consoleNick:"unknown",gameDataCursor:Uint8Array.from([0,0,0,0,0,0,0,0]),version:"",clientToken:0},Re=function(e){function t(){var t=e.call(this)||this;return t.connectionStatus=exports.ConnectionStatus.DISCONNECTED,t.connDetails=B({},Fe),t.ipAddress="0.0.0.0",t.port=exports.Ports.DEFAULT,t.clientsByPort=[],t.connectionsByPort=[],t}return R(t,e),t.prototype.getStatus=function(){return this.connectionStatus},t.prototype.getSettings=function(){return{ipAddress:this.ipAddress,port:this.port}},t.prototype.getDetails=function(){return this.connDetails},t.prototype.connect=function(e,t,r){void 0===r&&(r=2e4),this.ipAddress=e,this.port=t,t===exports.Ports.LEGACY||t===exports.Ports.DEFAULT?(this._connectOnPort(exports.Ports.DEFAULT,r),this._connectOnPort(exports.Ports.LEGACY,r)):this._connectOnPort(t,r)},t.prototype._connectOnPort=function(e,t){var r=this,n=h((function(){return f.connect({host:r.ipAddress,port:e,timeout:t})}));this._setStatus(exports.ConnectionStatus.CONNECTING);var o=new Ie,a=n({initialDelay:2e3,maxDelay:1e4,strategy:"fibonacci",failAfter:1/0},(function(n){r.clientsByPort[e]=n;var a=Te.INITIAL;n.on("data",(function(e){if(a===Te.INITIAL&&(a=r._getInitialCommState(e),console.log("Connected to "+r.ipAddress+":"+r.port+" with type: "+a),r._setStatus(exports.ConnectionStatus.CONNECTED),console.log(e.toString("hex"))),a!==Te.LEGACY){try{o.receive(e)}catch(t){return console.warn("Failed to process new data from server...",{error:t,prevDataBuf:o.getReceiveBuffer(),rcvData:e}),void n.destroy()}var t=o.getMessages();try{t.forEach((function(e){return r._processMessage(e)}))}catch(e){n.destroy(),console.error(e)}}else r._handleReplayData(e)})),n.on("timeout",(function(){console.warn("Attempted connection to "+r.ipAddress+":"+r.port+" timed out after "+t+"ms"),n.destroy()})),n.on("end",(function(){console.log("disconnect"),n.destroy()})),n.on("close",(function(){console.log("connection was closed")}));var s=o.genHandshakeOut(r.connDetails.gameDataCursor,r.connDetails.clientToken);n.write(s)})),s=function(){r._setStatus(exports.ConnectionStatus.CONNECTING)};a.on("connect",s),a.on("reconnect",s),a.on("disconnect",(function(){r.connectionsByPort.forEach((function(t,r){r!==e&&t.connected&&(a.reconnect=!1,a.disconnect())}))})),a.on("error",(function(t){console.error("Connection on port "+e+" encountered an error.",t)})),this.connectionsByPort[e]=a,console.log("Starting connection"),a.connect(e)},t.prototype.disconnect=function(){console.log("Disconnect request"),this.connectionsByPort.forEach((function(e){e.reconnect=!1,e.disconnect()})),this.clientsByPort.forEach((function(e){e.destroy()})),this._setStatus(exports.ConnectionStatus.DISCONNECTED)},t.prototype._getInitialCommState=function(e){if(e.length<13)return Te.LEGACY;var t=Buffer.from([123,105,4,116,121,112,101,85,1]);return e.slice(4,13).equals(t)?Te.NORMAL:Te.LEGACY},t.prototype._processMessage=function(e){switch(e.type){case _e.KEEP_ALIVE:var t=Buffer.from("HELO\0");this._handleReplayData(t);break;case _e.REPLAY:var r=Uint8Array.from(e.payload.pos),n=Buffer.compare(this.connDetails.gameDataCursor,r);if(!e.payload.forcePos&&0!==n)throw console.warn("Position of received data is not what was expected. Expected, Received:",this.connDetails.gameDataCursor,r),new Error("Position of received data is incorrect.");e.payload.forcePos&&console.warn("Overflow occured in Nintendont, data has likely been skipped and replay corrupted. Expected, Received:",this.connDetails.gameDataCursor,r),this.connDetails.gameDataCursor=Uint8Array.from(e.payload.nextPos);var o=Uint8Array.from(e.payload.data);this._handleReplayData(o);break;case _e.HANDSHAKE:this.connDetails.consoleNick=e.payload.nick;var a=Buffer.from(e.payload.clientToken);this.connDetails.clientToken=a.readUInt32BE(0),this.connDetails.version=e.payload.nintendontVersion,this.connDetails.gameDataCursor=Uint8Array.from(e.payload.pos),this.emit(exports.ConnectionEvent.HANDSHAKE,this.connDetails)}},t.prototype._handleReplayData=function(e){this.emit(exports.ConnectionEvent.DATA,e)},t.prototype._setStatus=function(e){this.connectionStatus=e,this.emit(exports.ConnectionEvent.STATUS_CHANGE,this.connectionStatus)},t}(l.EventEmitter);(xe=exports.SlpStreamMode||(exports.SlpStreamMode={})).AUTO="AUTO",xe.MANUAL="MANUAL";var Pe,Be={suppressErrors:!1,mode:exports.SlpStreamMode.AUTO};(Pe=exports.SlpStreamEvent||(exports.SlpStreamEvent={})).RAW="slp-raw",Pe.COMMAND="slp-command";var we=function(e){function t(t,r){var n=e.call(this,r)||this;return n.gameEnded=!1,n.payloadSizes=null,n.previousBuffer=Buffer.from([]),n.settings=Object.assign({},Be,t),n}return R(t,e),t.prototype.restart=function(){this.gameEnded=!1,this.payloadSizes=null},t.prototype._write=function(e,t,r){if("buffer"!==t)throw new Error("Unsupported stream encoding. Expected 'buffer' got '"+t+"'.");var n=Uint8Array.from(Buffer.concat([this.previousBuffer,e]));this.previousBuffer=Buffer.from([]);for(var o=new DataView(n.buffer),a=0;a<n.length;)if("HELO\0"!==Buffer.from(n.slice(a,a+5)).toString()){var s=o.getUint8(a),i=this.payloadSizes&&this.payloadSizes.has(s)?this.payloadSizes.get(s):0;if(n.length-a<i+1){this.previousBuffer=n.slice(a);break}if(this.settings.mode===exports.SlpStreamMode.MANUAL&&this.gameEnded)break;a+=1;var u=n.slice(a),c=new DataView(n.buffer,a),l=0;try{l=this._processCommand(s,u,c)}catch(e){if(!this.settings.suppressErrors)throw e;l=0}a+=l}else a+=5;r()},t.prototype._writeCommand=function(e,t,r){var n=t.slice(0,r),o=Buffer.concat([Buffer.from([e]),n]);return this.emit(exports.SlpStreamEvent.RAW,{command:e,payload:o}),new Uint8Array(o)},t.prototype._processCommand=function(e,t,r){if(e===exports.Command.MESSAGE_SIZES&&null===this.payloadSizes){var n=r.getUint8(0);return this.payloadSizes=Oe(r),this._writeCommand(e,t,n),this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:this.payloadSizes}),n}var o,a=this.payloadSizes&&this.payloadSizes.has(e)?this.payloadSizes.get(e):0;if(a>0&&(o=g(e,this._writeCommand(e,t,a))),!o)return a;switch(e){case exports.Command.GAME_END:this.settings.mode===exports.SlpStreamMode.MANUAL?this.gameEnded=!0:this.payloadSizes=null}return this.emit(exports.SlpStreamEvent.COMMAND,{command:e,payload:o}),a},t}(m.Writable),Oe=function(e){for(var t=new Map,r=e.getUint8(0),n=1;n<r;n+=3){var o=e.getUint8(n),a=e.getUint16(n+1);t.set(o,a)}return t},Le=function(e){function t(t,r,n){var o=e.call(this,n)||this;return o.rawDataLength=0,o.usesExternalStream=!1,o.filePath=t,o.metadata={consoleNickname:"unknown",startTime:p(),lastFrame:-124,players:{}},o.usesExternalStream=Boolean(r),o.slpStream=r||new we({mode:exports.SlpStreamMode.MANUAL}),o._setupListeners(),o._initializeNewGame(o.filePath),o}return R(t,e),t.prototype.path=function(){return this.filePath},t.prototype.setMetadata=function(e){this.metadata=Object.assign({},this.metadata,e)},t.prototype._write=function(e,t,r){if("buffer"!==t)throw new Error("Unsupported stream encoding. Expected 'buffer' got '"+t+"'.");this.fileStream.write(e),this.usesExternalStream||this.slpStream.write(e),this.rawDataLength+=e.length,r()},t.prototype._onCommand=function(e){var t,r=e.command,n=e.payload;switch(r){case exports.Command.POST_FRAME_UPDATE:var a=n,s=a.frame,i=a.playerIndex,u=a.isFollower,c=a.internalCharacterId;if(u)break;this.metadata.lastFrame=s;var l=o.get(this.metadata,["players",""+i])||{},p=l.characterUsage||{},m=p[c]||0,f=B(B({},l),{characterUsage:B(B({},p),(t={},t[c]=m+1,t))});this.metadata.players[""+i]=f}},t.prototype._setupListeners=function(){var e=this,t=function(t){e._onCommand(t)};this.slpStream.on(exports.SlpStreamEvent.COMMAND,t),this.on("finish",(function(){var r=s.openSync(e.filePath,"r+");s.writeSync(r,Ge(e.rawDataLength),0,"binary",11),s.closeSync(r),e.slpStream.removeListener(exports.SlpStreamEvent.COMMAND,t),e.usesExternalStream||e.slpStream.end()}))},t.prototype._initializeNewGame=function(e){this.fileStream=s.createWriteStream(e,{encoding:"binary"});var t=Buffer.concat([Buffer.from("{U"),Buffer.from([3]),Buffer.from("raw[$U#l"),Buffer.from([0,0,0,0])]);this.fileStream.write(t)},t.prototype._final=function(e){var t=Buffer.concat([Buffer.from("U"),Buffer.from([8]),Buffer.from("metadata{")]),r=this.metadata.startTime.toISOString();t=Buffer.concat([t,Buffer.from("U"),Buffer.from([7]),Buffer.from("startAtSU"),Buffer.from([r.length]),Buffer.from(r)]);var n=this.metadata.lastFrame;t=Buffer.concat([t,Buffer.from("U"),Buffer.from([9]),Buffer.from("lastFramel"),Ue(n)]);var a=this.metadata.consoleNickname||"unknown";t=Buffer.concat([t,Buffer.from("U"),Buffer.from([11]),Buffer.from("consoleNickSU"),Buffer.from([a.length]),Buffer.from(a)]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([7]),Buffer.from("players{")]);var s=this.metadata.players;o.forEach(s,(function(e,r){t=Buffer.concat([t,Buffer.from("U"),Buffer.from([r.length]),Buffer.from(r+"{")]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([10]),Buffer.from("characters{")]),o.forEach(e.characterUsage,(function(e,r){t=Buffer.concat([t,Buffer.from("U"),Buffer.from([r.length]),Buffer.from(r+"l"),Ge(e)])})),t=Buffer.concat([t,Buffer.from("}}")])})),t=Buffer.concat([t,Buffer.from("}")]),t=Buffer.concat([t,Buffer.from("U"),Buffer.from([8]),Buffer.from("playedOnSU"),Buffer.from([7]),Buffer.from("network")]),t=Buffer.concat([t,Buffer.from("}}")]),this.fileStream.write(t,e)},t}(m.Writable),Ue=function(e){var t=Buffer.alloc(4);return t.writeInt32BE(e,0),t},Ge=function(e){var t=Buffer.alloc(4);return t.writeUInt32BE(e,0),t};var Me,ke={outputFiles:!0,folderPath:".",consoleNickname:"unknown",newFilename:function(e,t){return d.join(e,"Game_"+t.format("YYYYMMDD")+"T"+t.format("HHmmss")+".slp")}};(Me=exports.SlpFileWriterEvent||(exports.SlpFileWriterEvent={})).NEW_FILE="new-file",Me.FILE_COMPLETE="file-complete";var be=function(e){function t(t,r,n){var o=e.call(this,r,n)||this;return o.options=Object.assign({},ke,t),o._setupListeners(),o}return R(t,e),t.prototype._writePayload=function(e){this.currentFile&&this.currentFile.write(e)},t.prototype._setupListeners=function(){var e=this;this.on(exports.SlpStreamEvent.RAW,(function(t){var r=t.command,n=t.payload;switch(r){case exports.Command.MESSAGE_SIZES:e._handleNewGame(),e._writePayload(n);break;case exports.Command.GAME_END:e._writePayload(n),e._handleEndGame();break;default:e._writePayload(n)}}))},t.prototype.getCurrentFilename=function(){return null!==this.currentFile?d.resolve(this.currentFile.path()):null},t.prototype.updateSettings=function(e){this.options=Object.assign({},this.options,e)},t.prototype._handleNewGame=function(){if(this.options.outputFiles){var e=this.options.newFilename(this.options.folderPath,p());this.currentFile=new Le(e,this),this.emit(exports.SlpFileWriterEvent.NEW_FILE,e)}},t.prototype._handleEndGame=function(){this.currentFile&&(this.currentFile.setMetadata({consoleNickname:this.options.consoleNickname}),this.currentFile.end(),this.emit(exports.SlpFileWriterEvent.FILE_COMPLETE,this.currentFile.path()),this.currentFile=null)},t}(we);exports.ActionsComputer=z,exports.ComboComputer=X,exports.ConsoleConnection=Re,exports.ConversionComputer=Z,exports.Frames=O,exports.InputComputer=ee,exports.MAX_ROLLBACK_FRAMES=7,exports.NETWORK_MESSAGE="HELO\0",exports.SlippiGame=le,exports.SlpFile=Le,exports.SlpFileWriter=be,exports.SlpParser=ce,exports.SlpStream=we,exports.Stats=ne,exports.StockComputer=$,exports.Timers=w,exports.animations=pe,exports.calcDamageTaken=Y,exports.characters=he,exports.default=le,exports.didLoseStock=U,exports.generateOverallStats=oe,exports.getSinglesPlayerPermutationsFromSettings=L,exports.isDamaged=b,exports.isDead=H,exports.isDown=k,exports.isGrabbed=W,exports.isInControl=G,exports.isTeching=M,exports.moves=ye,exports.stages=ve;
